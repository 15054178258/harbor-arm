name: Build and Release Harbor ARM64

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Harbor ç‰ˆæœ¬å· (ä¾‹å¦‚: v2.14.0)'
        required: true
        default: 'v2.14.0'

jobs:
  release-arm-harbor:
    runs-on: ubuntu-latest
    permissions: # å¿…é¡»å¼€å¯å†™å…¥æƒé™æ‰èƒ½åˆ›å»º Release
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare ARM64 Images
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE_REGISTRY="ghcr.io/octohelm/harbor"
          TARGET_REGISTRY="goharbor"
          
          # å®šä¹‰é•œåƒæ˜ å°„åˆ—è¡¨
          IMAGES=(
            "harbor-log" "registry-photon" "harbor-registryctl" 
            "harbor-db" "harbor-core" "harbor-portal" 
            "harbor-jobservice" "redis-photon" "nginx-photon"
          )
          
          echo "ğŸš€ æ­£åœ¨æ‹‰å–å¹¶å¤„ç† ARM64 é•œåƒ..."
          FINAL_TAGS=()
          for img in "${IMAGES[@]}"; do
            docker pull --platform linux/arm64 "$SOURCE_REGISTRY/$img:$VERSION"
            docker tag "$SOURCE_REGISTRY/$img:$VERSION" "$TARGET_REGISTRY/$img:$VERSION"
            FINAL_TAGS+=("$TARGET_REGISTRY/$img:$VERSION")
          done
          
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…é•œåƒ..."
          docker save "${FINAL_TAGS[@]}" -o harbor.$VERSION.tar
          gzip -9 harbor.$VERSION.tar
          echo "é•œåƒåŒ…å·²ç”Ÿæˆ: harbor.$VERSION.tar.gz"

      - name: Download and Patch Official Installer
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹ $VERSION ç¦»çº¿å®‰è£…åŒ…..."
          wget -q https://github.com/goharbor/harbor/releases/download/$VERSION/harbor-offline-installer-$VERSION.tgz
          
          echo "ğŸ› ï¸ æ›¿æ¢é•œåƒæ–‡ä»¶..."
          tar -xvf harbor-offline-installer-$VERSION.tgz
          # æ›¿æ¢ x86 é•œåƒä¸ºæˆ‘ä»¬ç”Ÿæˆçš„ ARM é•œåƒ
          mv harbor.$VERSION.tar.gz harbor/harbor.$VERSION.tar.gz
          
          echo "æ‰“åŒ…æœ€ç»ˆå®‰è£…ç¨‹åº..."
          tar -zcvf harbor-arm64-installer-$VERSION.tgz harbor/

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}-arm64
          name: Harbor ARM64 Release ${{ github.event.inputs.version }}
          body: |
            Harbor ARM64 ç¦»çº¿å®‰è£…åŒ… è‡ªåŠ¨æ„å»ºç‰ˆ
            - åŸºç¡€ç‰ˆæœ¬: ${{ github.event.inputs.version }}
            - æ¶æ„: linux/arm64
            - é•œåƒæ¥æº: octohelm/harbor (Photon OS Based)
          draft: false
          prerelease: false
          files: |
            harbor-arm64-installer-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

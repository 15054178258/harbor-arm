name: Build Harbor ARM v2.10.3 to GHCR

on:
  workflow_dispatch:

# 必须声明权限，否则无法推送到 GHCR
permissions:
  contents: read
  packages: write

jobs:
  build-harbor-arm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Harbor Source
        uses: actions/checkout@v4
        with:
          repository: goharbor/harbor
          ref: v2.10.3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # Harbor 2.10.x 建议使用 1.21

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 第一步：编译 ARM64 二进制文件 (Core 和 Jobservice)
      # 只有这样 Dockerfile 里的 COPY 语句才不会报错
      - name: Compile Harbor Binaries (ARM64)
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          # 编译 core
          go build -v -o make/photon/core/harbor_core ./src/core
          # 编译 jobservice
          go build -v -o make/photon/jobservice/harbor_jobservice ./src/jobservice
          # 编译 registryctl
          go build -v -o make/photon/registryctl/harbor_registryctl ./src/registryctl

      # 第二步：参考博客，对 Redis 进行补丁处理 (适配 64KB Page Size)
      - name: Patch Redis for ARM
        run: |
          # 修改 Redis 编译参数，确保支持国产化 ARM 环境的 Page Size
          if [ -f make/photon/redis/Dockerfile ]; then
            sed -i 's/--with-lg-page=12/--with-lg-page=16/g' make/photon/redis/Dockerfile || true
          fi

      # 第三步：构建并推送镜像
      # 这里解决了你遇到的参数为空导致报错的问题
      - name: Build and Push Core Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --build-arg harbor_base_namespace=goharbor \
            --build-arg harbor_base_image_version=v2.10.3 \
            -t ghcr.io/${{ github.repository_owner }}/harbor-core:v2.10.3-arm64 \
            -f make/photon/core/Dockerfile ./make/photon/core --push

      - name: Build and Push Redis Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --build-arg harbor_base_namespace=goharbor \
            --build-arg harbor_base_image_version=v2.10.3 \
            -t ghcr.io/${{ github.repository_owner }}/harbor-redis:v2.10.3-arm64 \
            -f make/photon/redis/Dockerfile ./make/photon/redis --push

      # 可以根据需要继续添加 Jobservice, Portal 等组件的构建步骤

name: Harbor ARM64 Full Release Factory

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Harbor Version (e.g., v2.10.2 or v2.14.0)'
        required: true
        default: 'v2.14.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # æ³¨æ„ï¼šå»æ‰äº† Buildx å’Œ QEMU æ’ä»¶ï¼Œé¿å… containerd å­˜å‚¨å†²çª
      
      - name: Prepare Full ARM64 Images
        id: prepare_images
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE_REGISTRY="ghcr.io/octohelm/harbor"
          TARGET_REGISTRY="goharbor"
          
          # å¼€å¯ Docker å®éªŒæ€§åŠŸèƒ½ä»¥æ”¯æŒ --platform
          export DOCKER_CLI_EXPERIMENTAL=enabled
          
          declare -A IMAGES=(
            ["harbor-log"]="harbor-log"
            ["registry-photon"]="registry-photon"
            ["harbor-registryctl"]="harbor-registryctl"
            ["harbor-db"]="harbor-db"
            ["harbor-core"]="harbor-core"
            ["harbor-portal"]="harbor-portal"
            ["harbor-jobservice"]="harbor-jobservice"
            ["redis-photon"]="redis-photon"
            ["nginx-photon"]="nginx-photon"
            ["harbor-exporter"]="harbor-exporter"
            ["chartmuseum-photon"]="chartmuseum-photon"
            ["trivy-adapter-photon"]="trivy-adapter-photon"
            ["prepare-photon"]="harbor-prepare"
          )
          
          echo "ğŸš€ æ­£åœ¨å¤„ç†å…¨é‡ ARM64 é•œåƒ..."
          FINAL_TAGS=()
          for KEY in "${!IMAGES[@]}"; do
            SOURCE_IMG="$SOURCE_REGISTRY/$KEY:$VERSION"
            TARGET_IMG="$TARGET_REGISTRY/${IMAGES[$KEY]}:$VERSION"
            
            echo "ğŸ“¥ Pulling: $SOURCE_IMG"
            # ä½¿ç”¨åŸç”Ÿ docker pullï¼Œç¡®ä¿é•œåƒè¿›å…¥åŸç”Ÿå­˜å‚¨æ± 
            if docker pull --platform linux/arm64 "$SOURCE_IMG"; then
                docker tag "$SOURCE_IMG" "$TARGET_IMG"
                FINAL_TAGS+=("$TARGET_IMG")
                echo "âœ… Tagged: $TARGET_IMG"
            else
                echo "âš ï¸ Skip: $SOURCE_IMG ä¸å­˜åœ¨äºæºä»“åº“"
            fi
          done
          
          echo "ğŸ“¦ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆé•œåƒåŒ… (tar.gz)..."
          # ç›´æ¥ä¿å­˜ä¸º tar 
          docker save "${FINAL_TAGS[@]}" -o harbor.$VERSION.tar
          # éšåå‹ç¼©
          gzip -9 harbor.$VERSION.tar
          echo "IMAGE_FILE=harbor.$VERSION.tar.gz" >> $GITHUB_ENV

      - name: Patch and Package Installer
        run: |
          VERSION="${{ github.event.inputs.version }}"
          INSTALLER_FILE="harbor-offline-installer-$VERSION.tgz"
          
          echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹ç¦»çº¿å®‰è£…åŒ…æ¨¡æ¿..."
          wget -q "https://github.com/goharbor/harbor/releases/download/$VERSION/$INSTALLER_FILE"
          
          echo "ğŸ› ï¸ æ­£åœ¨æ›¿æ¢æ¶æ„åŒ…..."
          tar -xvf "$INSTALLER_FILE"
          
          # æ›¿æ¢å®˜æ–¹åŒ…é‡Œçš„é•œåƒåŒ…
          mv "harbor.$VERSION.tar.gz" "harbor/harbor.$VERSION.tar.gz"
          
          # é‡æ–°å‹ç¼©
          FINAL_PACKAGE="harbor-arm64-installer-$VERSION.tgz"
          tar -zcvf "$FINAL_PACKAGE" harbor/
          echo "FINAL_PACKAGE=$FINAL_PACKAGE" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}-arm64
          name: Harbor ARM64 Release ${{ github.event.inputs.version }}
          body: |
            ### Harbor ARM64 ç¦»çº¿å®‰è£…åŒ…
            - **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
            - **æ¶æ„**: linux/arm64
            
            **åŒ…å«ç»„ä»¶**:
            - æ ¸å¿ƒæœåŠ¡ + æ•°æ®åº“ + Redis + Nginx
            - Exporter / Chartmuseum / Trivy Adapter
            - **Prepare (å…³é”®å®‰è£…ç»„ä»¶)**
          files: |
            harbor-arm64-installer-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

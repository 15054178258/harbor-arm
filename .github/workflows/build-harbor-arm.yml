name: Build Harbor ARM v2.10.3

on:
  workflow_dispatch: # 手动触发

jobs:
  build-arm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Harbor Source
        uses: actions/checkout@v4
        with:
          repository: goharbor/harbor
          ref: v2.10.3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 关键步骤：修改 Redis 编译参数 (借鉴博客内容)
      - name: Patch Redis for ARM Page Size
        run: |
          # 找到 Redis 的 Dockerfile 或相关编译脚本
          # 修改 Makefile 或配置，确保包含 --with-lg-page=16
          sed -i 's/--with-lg-page=12/--with-lg-page=16/g' make/photon/redis/Dockerfile || true

      - name: Build and Push Core Image
        run: |
          # 以核心组件为例，指定平台为 arm64
          docker buildx build \
            --platform linux/arm64 \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/harbor-core:v2.10.3-arm64 \
            -f make/photon/core/Dockerfile . --push

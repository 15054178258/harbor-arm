name: Harbor ARM64 Full Release Factory

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Harbor Version (e.g., v2.10.2 or v2.14.0)'
        required: true
        default: 'v2.14.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Prepare Full ARM64 Images (via Skopeo)
        id: prepare_images
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE_REGISTRY="ghcr.io/octohelm/harbor"
          TARGET_REGISTRY="goharbor"
          
          # ä¿®æ­£æ˜ å°„ï¼šoctohelm ç«¯çš„ key ä¸º prepare
          declare -A IMAGES=(
            ["harbor-log"]="harbor-log"
            ["registry-photon"]="registry-photon"
            ["harbor-registryctl"]="harbor-registryctl"
            ["harbor-db"]="harbor-db"
            ["harbor-core"]="harbor-core"
            ["harbor-portal"]="harbor-portal"
            ["harbor-jobservice"]="harbor-jobservice"
            ["redis-photon"]="redis-photon"
            ["nginx-photon"]="nginx-photon"
            ["harbor-exporter"]="harbor-exporter"
            ["chartmuseum-photon"]="chartmuseum-photon"
            ["trivy-adapter-photon"]="trivy-adapter-photon"
            ["prepare"]="harbor-prepare" 
          )
          
          mkdir -p ./images_dir
          
          echo "ğŸš€ æ­£åœ¨é€šè¿‡ Skopeo ä¸‹è½½å¹¶æ‰“æ ‡ ARM64 é•œåƒ..."
          for KEY in "${!IMAGES[@]}"; do
            SOURCE_IMG="docker://$SOURCE_REGISTRY/$KEY:$VERSION"
            LOCAL_NAME="${IMAGES[$KEY]}"
            
            echo "ğŸ“¥ Copying: $SOURCE_IMG"
            # ä½¿ç”¨ skopeo ç›´æ¥æ‹‰å– arm64 æ¶æ„å¹¶ä¿å­˜ä¸ºæœ¬åœ° docker-archive æ ¼å¼
            if skopeo copy --override-os linux --override-arch arm64 --src-tls-verify=true \
               "$SOURCE_IMG" "docker-archive:./images_dir/$LOCAL_NAME.tar:$TARGET_REGISTRY/$LOCAL_NAME:$VERSION"; then
                echo "âœ… Saved: $LOCAL_NAME"
            else
                echo "âš ï¸ Skip: $SOURCE_IMG ä¸å­˜åœ¨"
            fi
          done
          
          echo "ğŸ“¦ æ­£åœ¨åˆå¹¶é•œåƒå¹¶ç”Ÿæˆæœ€ç»ˆå®‰è£…åŒ…æ‰€éœ€çš„ harbor.tar.gz..."
          # å°†æ‰€æœ‰åˆ†å— tar åŠ è½½åˆ°æœ¬åœ° dockerï¼ˆæœ¬åœ°åŠ è½½ä¸æ¶‰åŠæ¶æ„æ ¡éªŒï¼Œä¸ä¼šæŠ¥é”™ï¼‰
          for f in ./images_dir/*.tar; do docker load -i "$f"; done
          
          # è·å–æ‰€æœ‰æ‰“æ ‡ä¸º goharbor çš„é•œåƒå¹¶ä¿å­˜
          FINAL_TAGS=$(docker images --format "{{.Repository}}:{{.Tag}}" | grep "$TARGET_REGISTRY/")
          docker save $FINAL_TAGS -o harbor.$VERSION.tar
          gzip -9 harbor.$VERSION.tar
          echo "IMAGE_FILE=harbor.$VERSION.tar.gz" >> $GITHUB_ENV

      - name: Patch and Package Installer
        run: |
          VERSION="${{ github.event.inputs.version }}"
          INSTALLER_FILE="harbor-offline-installer-$VERSION.tgz"
          
          echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹å®‰è£…åŒ…æ¨¡æ¿..."
          wget -q "https://github.com/goharbor/harbor/releases/download/$VERSION/$INSTALLER_FILE"
          
          echo "ğŸ› ï¸ æ›¿æ¢é•œåƒæ–‡ä»¶..."
          tar -xvf "$INSTALLER_FILE"
          mv "harbor.$VERSION.tar.gz" "harbor/harbor.$VERSION.tar.gz"
          
          FINAL_PACKAGE="harbor-arm64-installer-$VERSION.tgz"
          tar -zcvf "$FINAL_PACKAGE" harbor/
          echo "FINAL_PACKAGE=$FINAL_PACKAGE" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}-arm64
          name: Harbor ARM64 Release ${{ github.event.inputs.version }}
          body: |
            ### Harbor ARM64 ç¦»çº¿å®‰è£…åŒ… (Octohelm Source)
            - **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
            - **æ¶æ„**: linux/arm64
            
            **åŒ…å«ç»„ä»¶**: 
            Core, DB, Redis, Nginx, Jobservice, Registry, Exporter, Chartmuseum, Trivy Adapter, ä»¥åŠ **Prepare** ç¯å¢ƒã€‚
          files: harbor-arm64-installer-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

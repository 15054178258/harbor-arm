name: Build Harbor ARM v2.10.3 to GHCR

on:
  workflow_dispatch:

# 必须添加 permissions 以允许推送到 GHCR
permissions:
  contents: read
  packages: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Harbor Source
        uses: actions/checkout@v4
        with:
          repository: goharbor/harbor
          ref: v2.10.3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 关键步骤：登录到 GitHub Container Registry
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 参考博客：对 Redis 进行 64KB Page Size 补丁处理
      - name: Patch Redis for ARM
        run: |
          # 进入 Redis 目录（根据 Harbor 2.10.3 源码结构）
          # 确保 jemalloc 编译参数包含 --with-lg-page=16
          sed -i 's/--with-lg-page=12/--with-lg-page=16/g' make/photon/redis/Dockerfile || true

      # 构建并推送（以 Core 组件为例）
      - name: Build and Push Harbor Core
        run: |
          docker buildx build \
            --platform linux/arm64 \
            -t ghcr.io/${{ github.repository_owner }}/harbor-core:v2.10.3-arm64 \
            -f make/photon/core/Dockerfile . --push

name: Harbor ARM64 Full Release Factory

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Harbor Version (e.g., v2.10.2 or v2.14.0)'
        required: true
        default: 'v2.14.0'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare Full ARM64 Images
        id: prepare_images
        run: |
          VERSION="${{ github.event.inputs.version }}"
          SOURCE_REGISTRY="ghcr.io/octohelm/harbor"
          TARGET_REGISTRY="goharbor"
          
          # æ ¸å¿ƒé•œåƒåˆ—è¡¨ï¼šå®Œæ•´å¯¹é½å®˜æ–¹ offline installer
          declare -A IMAGES=(
            ["harbor-log"]="harbor-log"
            ["registry-photon"]="registry-photon"
            ["harbor-registryctl"]="harbor-registryctl"
            ["harbor-db"]="harbor-db"
            ["harbor-core"]="harbor-core"
            ["harbor-portal"]="harbor-portal"
            ["harbor-jobservice"]="harbor-jobservice"
            ["redis-photon"]="redis-photon"
            ["nginx-photon"]="nginx-photon"
            ["harbor-exporter"]="harbor-exporter"
            ["chartmuseum-photon"]="chartmuseum-photon"
            ["trivy-adapter-photon"]="trivy-adapter-photon"
            ["prepare-photon"]="harbor-prepare"
          )
          
          echo "ğŸš€ æ­£åœ¨å¤„ç†å…¨é‡ ARM64 é•œåƒ..."
          FINAL_TAGS=()
          for KEY in "${!IMAGES[@]}"; do
            SOURCE_IMG="$SOURCE_REGISTRY/$KEY:$VERSION"
            TARGET_IMG="$TARGET_REGISTRY/${IMAGES[$KEY]}:$VERSION"
            
            echo "ğŸ“¥ Pulling: $SOURCE_IMG"
            # å°è¯•æ‹‰å–ï¼Œå¦‚æœå¤±è´¥åˆ™è¾“å‡ºè­¦å‘Šå¹¶è·³è¿‡ï¼ˆå…¼å®¹éƒ¨åˆ†ç‰ˆæœ¬ç¼ºå°‘ç»„ä»¶çš„æƒ…å†µï¼‰
            if docker pull --platform linux/arm64 "$SOURCE_IMG"; then
                docker tag "$SOURCE_IMG" "$TARGET_IMG"
                FINAL_TAGS+=("$TARGET_IMG")
                echo "âœ… Tagged: $TARGET_IMG"
            else
                echo "âš ï¸ Skip: $SOURCE_IMG ä¸å­˜åœ¨äºæºä»“åº“"
            fi
          done
          
          echo "ğŸ“¦ æ­£åœ¨ç”Ÿæˆæœ€ç»ˆé•œåƒåŒ… (tar.gz)..."
          docker save "${FINAL_TAGS[@]}" -o harbor.$VERSION.tar
          gzip -9 harbor.$VERSION.tar
          echo "IMAGE_FILE=harbor.$VERSION.tar.gz" >> $GITHUB_ENV

      - name: Patch and Package Installer
        run: |
          VERSION="${{ github.event.inputs.version }}"
          INSTALLER_FILE="harbor-offline-installer-$VERSION.tgz"
          
          echo "ğŸ“¥ ä¸‹è½½å®˜æ–¹ç¦»çº¿å®‰è£…åŒ…æ¨¡æ¿..."
          wget -q "https://github.com/goharbor/harbor/releases/download/$VERSION/$INSTALLER_FILE"
          
          echo "ğŸ› ï¸ æ­£åœ¨æ›¿æ¢æ¶æ„åŒ…..."
          tar -xvf "$INSTALLER_FILE"
          
          # å®˜æ–¹åŒ…è§£å‹åä¼šæœ‰ harbor/ ç›®å½•ï¼Œé‡Œé¢æœ‰åŸç‰ˆçš„ harbor.v2.x.tar.gz
          # æˆ‘ä»¬ç”¨è‡ªå·±ç”Ÿæˆçš„å…¨é‡ ARM åŒ…ç›´æ¥è¦†ç›–å®ƒ
          mv "harbor.$VERSION.tar.gz" "harbor/harbor.$VERSION.tar.gz"
          
          # é‡æ–°å‹ç¼©ä¸º ARM ç‰ˆå®‰è£…åŒ…
          FINAL_PACKAGE="harbor-arm64-installer-$VERSION.tgz"
          tar -zcvf "$FINAL_PACKAGE" harbor/
          echo "FINAL_PACKAGE=$FINAL_PACKAGE" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}-arm64
          name: Harbor ARM64 Release ${{ github.event.inputs.version }}
          body: |
            ### Harbor ARM64 ç¦»çº¿å®‰è£…åŒ…
            - **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
            - **æ¶æ„**: linux/arm64
            - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
            
            **åŒ…å«ç»„ä»¶**:
            - Harbor Core / Jobservice / Portal / Log
            - Registry / Registryctl
            - Redis / Nginx / DB (Postgres)
            - Exporter / Chartmuseum / Trivy Adapter
            - **Prepare (å…³é”®å®‰è£…ç»„ä»¶)**
            
            **ä½¿ç”¨æ–¹æ³•**:
            1. ä¸‹è½½åä¸Šä¼ è‡³ ARM æœåŠ¡å™¨ã€‚
            2. `tar -xvf harbor-arm64-installer-${{ github.event.inputs.version }}.tgz`
            3. ä¿®æ”¹ `harbor.yml` åæ‰§è¡Œ `./install.sh`
          files: |
            harbor-arm64-installer-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

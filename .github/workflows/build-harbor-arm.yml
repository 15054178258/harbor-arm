name: Build Harbor ARM v2.10.3 to GHCR

on:
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build-harbor-arm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Harbor Source
        uses: actions/checkout@v4
        with:
          repository: goharbor/harbor
          ref: v2.10.3
          path: harbor_src

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Swagger
        run: |
          download_url=$(curl -s https://api.github.com/repos/go-swagger/go-swagger/releases/latest | grep "browser_download_url.*_linux_amd64" | cut -d '"' -f 4)
          sudo curl -o /usr/local/bin/swagger -L $download_url
          sudo chmod +x /usr/local/bin/swagger

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 关键修复：使用 go work 或手动修复 go.mod 替换路径
      # Harbor 的 src/go.mod 默认可能包含一些指向父目录的引用，导致在 Actions 环境下解析失败
      - name: Generate All Required Code
        run: |
          cd harbor_src/src
          # 执行 Swagger 生成，不仅是 v2.0，确保全量生成
          swagger generate server -f ../api/v2.0/swagger.yaml --target ./server/v2.0 --model-package models --server-package restapi --exclude-main
          # 运行 go mod tidy 强制 Go 重新扫描目录结构并识别新生成的 package
          go mod tidy

      - name: Compile Harbor Binaries (ARM64)
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0
        run: |
          cd harbor_src/src
          
          # 必须使用 -mod=mod 标志，强制 Go 忽略旧的 vendor 记录（如果有的话）并查找新生成的代码
          echo "Compiling Core..."
          go build -mod=mod -v -o ../make/photon/core/harbor_core ./core
          
          echo "Compiling Jobservice..."
          go build -mod=mod -v -o ../make/photon/jobservice/harbor_jobservice ./jobservice
          
          echo "Compiling Registryctl..."
          go build -mod=mod -v -o ../make/photon/registryctl/harbor_registryctl ./registryctl

      # 为 Core 准备必要的静态资源
      # Dockerfile 中会 COPY 这些文件，如果缺失，buildx 会报错
      - name: Prepare Static Resources
        run: |
          cd harbor_src
          cp -r src/core/static make/photon/core/
          cp -r src/core/views make/photon/core/

      - name: Patch Redis for ARM
        run: |
          cd harbor_src
          sed -i 's/--with-lg-page=12/--with-lg-page=16/g' make/photon/redis/Dockerfile || true

      - name: Build and Push Core Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --build-arg harbor_base_namespace=goharbor \
            --build-arg harbor_base_image_version=v2.10.3 \
            -t ghcr.io/${{ github.repository_owner }}/harbor-core:v2.10.3-arm64 \
            -f harbor_src/make/photon/core/Dockerfile ./harbor_src/make/photon/core --push

      - name: Build and Push Redis Image
        run: |
          docker buildx build \
            --platform linux/arm64 \
            --build-arg harbor_base_namespace=goharbor \
            --build-arg harbor_base_image_version=v2.10.3 \
            -t ghcr.io/${{ github.repository_owner }}/harbor-redis:v2.10.3-arm64 \
            -f harbor_src/make/photon/redis/Dockerfile ./harbor_src/make/photon/redis --push
